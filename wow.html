<!DOCTYPE html>
<html>
	<head>
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js"></script>
		<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
		<title>AH prices</title>
	</head>
	<body ng-app="app" ng-controller="main">

		<table class="pure-table">
			<thead>
		        <tr>
		            <th>Name</th>
		            <th>Zone</th>
		            <th>Flesh price</th>
		            <th>per hour</th>
		            <th>Basic cooked price</th>
		            <th>per hour </th>
		        </tr>
		    </thead>
			<tr ng-repeat="item in data.items">
				<td>{{item.name}}</td>
				<td>{{item.zone}}</td>
				<td>{{item.fleshValue}}</td>
				<td>{{item.fleshValueHourly}}</td>
				<td>{{item.basicCookedValue}}</td>
				<td>{{item.basicCookedValueHourly}}</td>
			</tr>
		</table>

	</body>
	<script>
		function Fish(name, zone, fleshID, basicCookedID) {
			this.name = name;
			this.zone = zone;
			this.fleshID = fleshID;
			this.fleshValue = 0;
			this.fleshValueHourly = 0;
			this.basicCookedID = basicCookedID;
			this.basicCookedValue = 0;
			this.basicCookedValueHourly = 0;
		}

		var data = {
			cookedPerFlesh: 0.5,
			fleshPops: [24,25,19,20,15,25,23,22,25,19,20,17,18,17,15,22,24,18,22,17,15],
			itemSessions: [
				{
					item: 0, //generally for all items
					sessions: [
						{duration: 40, pops: 20}
					]
				},
				{
					item: 109144, //whiptail
					sessions: [
						{duration: 27, pops: 40}
					]
				}
			],
			items: [
					new Fish("Gulper", "Spires", 109143, 111441),
					new Fish("Sleeper", "", 109139, 111444),
					new Fish("Sturgeon", "", 109140, 111442),
					new Fish("Skulker", "", 109138, 111446),
					new Fish("Scorpion", "", 109142, 111439),
					new Fish("Whiptail", "Telodar", 109144, -1),
					new Fish("Ammonite", "", 109141, -1)
			]
		};

		var sum = 0;
		for (var i = 0; i < data.fleshPops.length; i++) {
			sum += data.fleshPops[i];
		}
		data.fleshPopsAvg = sum / data.fleshPops.length;

		for (var i = 0; i < data.itemSessions.length; i++) {
			//calc hourly pops per session
			var sum = 0; 
			for (var j = 0; j < data.itemSessions[i].sessions.length; j++) {
				data.itemSessions[i].sessions[j].hourlyPops = 
					data.itemSessions[i].sessions[j].pops /
					data.itemSessions[i].sessions[j].duration * 60;

				sum += data.itemSessions[i].sessions[j].hourlyPops;
			}
			//calc overall avg for that item
			data.itemSessions[i].hourlyPopsAvg = sum / data.itemSessions[i].sessions.length;
		}

		var urlBase = "https://eu.theunderminejournal.com/api/search.php?house=243&search=";

		var app = angular.module("app", []);
		app.controller("main", ["$scope", "$http", function($scope, $http) {
			$scope.data = data;

			//on load: load prices of all items
			for (var i = 0; i < data.items.length; i++) {
				var localItem = data.items[i];

				$http.get(urlBase + localItem.name)
				.success(function(responseData) {
					console.log("Loaded data for item '" + localItem.name + "'");
					for (var j = 0; j < responseData.items.length; j++) {
						if (localItem.fleshID == responseData.items[j].id) {
							localItem.fleshValue = responseData.items[j].price;

							var hourlyPopsAvg = 0;
							for (var k = 0; k < data.itemSessions.length; k++) {
								if (localItem.fleshID == data.itemSessions[k].item) 
									hourlyPopsAvg = data.itemSessions[k].hourlyPopsAvg;
							}
							if (hourlyPopsAvg == 0) 
								hourlyPopsAvg = data.itemSessions[0].hourlyPopsAvg; //take the general one

							localItem.fleshValueHourly = localItem.fleshValue * hourlyPopsAvg * data.fleshPopsAvg;

						}
						else if (localItem.basicCookedID == responseData.items[j].id) {
							localItem.basicCookedValue = responseData.items[j].price;
						}
					}
				});
			}
		}]);


	</script>
</html>	